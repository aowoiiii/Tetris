<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <!--
	测试版俄罗斯方块V0.7
	编写日期:2018-05-24
-->
    <title> 俄罗斯方块 </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>
        table {
            border: 1px solid black
        }

        td {
            border: 1px solid;
            border-color: rgba(0, 0, 0, 0);
            width: 20px;
            height: 20px;
            font-size: 4px;
            background-color: white;
        }

        .next_shape_map {
            background-color: black;
        }

        .main_map {
            background-color: black;
        }

        .background_red {
            background-color: red;
        }

    </style>
</head>

<body>
<div style="float: left;">
    <table class="main_map">
        <script>
            for (var row = 0; row < 15; row++) {
                document.write("<tr>");
                for (var rank = 0; rank < 10; rank++) {
                    document.write("<td></td>");
                }
                document.write("</tr>");
            }
        </script>
    </table>
</div>

<div style="float:left;">
    <table style="margin-left: 20px" class="next_shape_map">
        <script>
            for (var row = 0; row < 4; row++) {
                document.write("<tr>");
                for (var rank = 0; rank < 4; rank++) {
                    document.write("<td></td>");
                }
                document.write("</tr>");
            }
        </script>
    </table>
    <div style="margin-left: 20px">
        <h3>得分</h3>
        <button id="start">开始</button>
        <button id="transform">转移</button>
    </div>
</div>
<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
<script>
    const shapes = [
        [[1, 1], [1, 2], [1, 3], [2, 3]],  // 1
        [[2, 1], [2, 2], [1, 3], [2, 3]],  // 2
        [[1, 1], [2, 1], [0, 2], [1, 2]],  // 3
        [[0, 1], [1, 1], [1, 2], [2, 2]],  // 4
        [[1, 1], [2, 1], [1, 2], [2, 2]],  // 5
        [[1, 0], [1, 1], [1, 2], [1, 3]],  // 6
        [[1, 1], [0, 2], [1, 2], [2, 2]],  // 7
    ];

    var next_shape_xy = [];
    var map_shape_xy = new Array(150);

    var next_shape_map_block = $(".next_shape_map").find("td"); // 子地图
    var main_map_block = $(".main_map").find("td"); // 主地图

    /*地图初始化*/
    var activity_shape_xy = new Array(150)
    for (let i = 0; i < activity_shape_xy.length; i++) {
        activity_shape_xy[i] = 0;
    }

    /* 下一个方块 坐标换算 */
    function next_shape(r_num) {
        console.log("下一个方块代码:" + parseInt(r_num + 1))
        for (let i = 0; i < shapes[r_num].length; i++) {
            let x = shapes[r_num][i][0];
            let y = shapes[r_num][i][1];
            next_shape_xy[i] = [x, y];  //小地图坐标
        }
    }

    /* 下一个方块渲染 */
    function next_shape_show() {
        for (let i = 0; i < next_shape_map_block.length; i++) {
            next_shape_map_block[i].style.background = "white";
        }

        for (let i = 0; i < next_shape_xy.length; i++) {
            next_shape_map_block[next_shape_xy[i][0] + next_shape_xy[i][1] * 4].style.background = "red";
        }
    }

    /* NEXT_SHAPE => ACTIVITY_SHAPE */
    function map_transform() {
        for (let i = 0; i < next_shape_xy.length; i++) {
            activity_shape_xy[next_shape_xy[i][0] + next_shape_xy[i][1] * 10 + 3] = 1; // 坐标转移并向右偏移 3
        }
    }

    /* 地图刷新 */
    function map() {
        for (let i = 0; i < map_shape_xy.length; i++) {
            if (activity_shape_xy[i] == 1 || activity_shape_xy[i] == 2 || map_shape_xy[i] == 2) {
                main_map_block[i].style.background = "red";
            }
        }
    }

    /* 非永久位置清空 */
    function init() {
        for (let i = 0; i < activity_shape_xy.length; i++) {
            if ((activity_shape_xy[i] != 2 || activity_shape_xy[i] != 3) && main_map_block[i] != undefined) {
                main_map_block[i].style.background = "white";
            }
        }
    }

    function control_move(e) {
        console.log(e)
        let MAX = 0;
        let activity_shape_temp_sign = [];
        let j = 0;
        for (let i = 0; i < activity_shape_xy.length; i++) {
            if (activity_shape_xy[i] == 1) {
                activity_shape_temp_sign [j] = i;
                j++;
                if (i > MAX) MAX = i;
            }
        }

        if (activity_shape_xy[MAX + 10] == undefined ||
            map_shape_xy[activity_shape_temp_sign[0] + 10] == 2 || map_shape_xy[activity_shape_temp_sign[1] + 10] == 2 ||
            map_shape_xy[activity_shape_temp_sign[2] + 10] == 2 || map_shape_xy[activity_shape_temp_sign[3] + 10] == 2) {
            for (let i = 0; i < map_shape_xy.length; i++) { // ==> 转实 2
                if (activity_shape_xy[i] == 1) {
                    map_shape_xy[i] = 2;
                }
                activity_shape_xy[i] = 0;
            }
        } else {
            switch (e) {

                case 1:

                    break;

                case 2:
                    activity_shape_xy.splice(141, 10);
                    activity_shape_xy.unshift(0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
                    break;

                case 3:
                    activity_shape_xy.splice(0, 1);
                    //activity_shape_xy.unshift(0);
                    break
                case 4:
                    activity_shape_xy.splice(150, 1);
                    activity_shape_xy.unshift(0);
                    break
            }
        }
        init();
        map();
    }


    $("button#start").click(function () {
        let r_num = Math.ceil(Math.random() * 6);
        next_shape(r_num);
        next_shape_show();
    })

    $("button#transform").click(function () {
        init();
        map_transform();
        map();
    })

    $(document).keydown(function (event) {
        var e = event || window.event
        if (e.keyCode == 38) {  //上
        } else if (e.keyCode == 40) { //下
            control_move(2);
        } else if (e.keyCode == 37) { //左
            control_move(3);
        } else if (e.keyCode == 39) { //右
            control_move(4);
        }
    });
</script>
</body>
</html>  