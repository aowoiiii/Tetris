<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title> 俄罗斯方块 </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style>
        table {
            border: 1px solid black
        }

        td {
            border: 1px solid;
            border-color: rgba(0, 0, 0, 0);
            width: 20px;
            height: 20px;
            font-size: 4px;
            background-color: white;
        }

        .map_next_shape, .map_main {
            background-color: black;
        }

        .background_red {
            background-color: red;
        }

    </style>
</head>

<body>
<div style="float: left;">
    <table class="map_main">
        <script>
            for (var row = 0; row < 15; row++) {
                document.write("<tr>");
                for (var rank = 0; rank < 10; rank++) {
                    document.write("<td></td>");
                }
                document.write("</tr>");
            }
        </script>
    </table>
</div>

<div style="float:left;">
    <table style="margin-left: 20px" class="map_next_shape">
        <script>
            for (var row = 0; row < 4; row++) {
                document.write("<tr>");
                for (var rank = 0; rank < 4; rank++) {
                    document.write("<td></td>");
                }
                document.write("</tr>");
            }
        </script>
    </table>
    <div style="margin-left: 20px">
        <h3>得分</h3>
        <button id="start">开始</button>
        <button id="transform">转移</button>
    </div>
</div>
<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
<script>
    const shapes = [
        [0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0],  // 1
        [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0],  // 2
        [0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0],  // 3
        [0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0],  // 4
        [0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0],  // 5
        [0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0],  // 6
        [0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0],  // 7
    ];
    var temp_n = [];
    var r_num;
    var shape_activity_temp = [];
    var temp_x = [], temp_y = []; // 边缘接触记录
    var control_x = 0, control_y = 0; //方向控制记录
    var map_shape_xy = new Array(150);
    var map_next_shape = $(".map_next_shape").find("td");   // 子地图 - 子元素为td块
    var map_main = $(".map_main").find("td");   // 主地图 - 子元素为td块
    var shape_next = []; //下一个图形 坐标
    var shape_temp_transform = []; //临时缓存地图 与 next_shape_xy相同
    var shape_activity = [] //活动图形
    var shape_rotate_temp = [];
    const rotate_method = [3, 7, 11, 15, 2, 6, 10, 14, 1, 5, 9, 13, 0, 4, 8, 12]
    const remove_method = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
    /*地图初始化*/
    var activity_shape_xy = new Array(150)
    for (let i = 0; i < activity_shape_xy.length; i++) {
        activity_shape_xy[i] = 0;
    }

    /* 小地图 下一个方块 生成 渲染*/
    function next_shape(r_num) {
        shape_temp_transform = shapes [r_num]; //临时转移
        console.log("下一个方块代码:" + parseInt(r_num + 1))
        for (i in shapes[r_num]) {
            map_next_shape[i].innerHTML = i;
            map_next_shape[i].style.background = "white";
            if (shapes[r_num][i] == 1) map_next_shape[i].style.background = "red";
        }
    }

    /* NEXT_SHAPE => ACTIVITY_SHAPE 左，右，下*/
    function temp_transform(x = 0, y = 0) {
        shape_activity = [], activity_shape_xy = []; //清空
        for (i in shape_temp_transform) {
            if (shape_temp_transform[i] == 1) {
                shape_activity.push([(i % 4 + x + 3), parseInt(i / 4 + y + (() => {
                    if (r_num != 5) return 0;  // 位置归零判断 非直线图形向上偏移
                    return 0
                })())])
            }
        }

        // for (i in map_shape_xy) {
        //     // console.log(parseInt(i / 10))
        //     console.log(i)
        // }

        for (let i = 0; i < 15; i++) {
            let num = 0;
            for (let j = 0; j < 10; j++) {
                if (map_shape_xy[i * 10 + j] == 2) num++;
                if (num == 10) console.log(i + ":消除")
            }
        }

        if (shape_activity.map(x => x[0]).map(x => x < 0 || x > 9).filter(x => x == true)[0]) {
            return control_x = temp_x[0]
        } else if (shape_activity.map(y => y[1]).map(y => y > 14).filter(y => y == true)[0] || shape_activity.map(n => map_shape_xy[n[0] + n[1] * 10] == 2).filter(n => n == true)[0]) {
            console.log("存储2")
            control_x = control_y = 0;
            temp_x[0] = temp_y[0] = 0;
            for (i in shape_activity_temp) {
                map_shape_xy [shape_activity_temp[i][0] + shape_activity_temp[i][1] * 10] = 2;
            }
            return control_y = temp_y[0];
        } else {
            shape_activity_temp = [];
            for (i in shape_activity) {
                activity_shape_xy[shape_activity[i][0] + shape_activity[i][1] * 10] = 1;
            }
            temp_x[0] = control_x, temp_y[0] = control_y;
        }
        shape_activity_temp = shape_activity;
        // console.log(x, y)
        // console.log(temp_x, temp_y)
        // console.log(map_shape_xy)
        // console.log(shape_temp_transform)
        // console.log(shape_activity);
        // console.log(activity_shape_xy)
        // console.log("-----------------------------------------------------------------------------------------------------")
        map();
    }

    /*消除*/
    // function remove() {
    //     console.log(map_shape_xy)
    // }
    //
    // remove();

    function rotate() { //旋转
        let new_shape_transform = [];
        for (let i in shape_temp_transform) {
            new_shape_transform[i] = shape_temp_transform [rotate_method[i]];
        }
        shape_temp_transform = new_shape_transform;
        temp_transform(control_x, control_y);
    }

    /* 大地图  形状生成 刷新 渲染  */
    function map() {
        for (let i = 0; i < map_shape_xy.length; i++) {
            map_main[i].style.background = "white";
            if (activity_shape_xy[i] == 1 || map_shape_xy[i] == 2) {
                map_main[i].style.background = "red";
            }
            map_main[i].innerHTML = i;
        }
    }

    /*控制移动*/
    function control_move(e) {
        switch (e) {
            case 1:
                rotate()
                break
            case 2:
                temp_transform(control_x, ++control_y);
                break;
            case 3:
                temp_transform(--control_x, control_y);
                break;
            case 4:
                temp_transform(++control_x, control_y);
                break;
        }
    }

    r_num = parseInt(7 * Math.random());
    next_shape(r_num);
    $("button#start").click(function () {

        temp_transform();
        setInterval(function () {
        }, 1000);
    })
    $("button#transform").click(function () {
        r_num = parseInt(7 * Math.random());
        next_shape(r_num);
        temp_transform();
    })
    $(document).keydown(function (event) {
        var e = event || window.event
        if (e.keyCode == 38) {
            //上
            control_move(1)
        } else if (e.keyCode == 40) { //下
            control_move(2);
        } else if (e.keyCode == 37) { //左
            control_move(3);
        } else if (e.keyCode == 39) { //右
            control_move(4);
        }
    });
</script>
</body>
</html>  